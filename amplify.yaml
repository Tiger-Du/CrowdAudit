version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Move into the app dir and install
        - cd apps/web
        - npm ci --cache .npm --prefer-offline
    build:
      commands:
        - npm run build
        # 1. Create a fresh deployment directory at the absolute root
        - mkdir -p ../../deploy
        
        # 2. Copy the standalone server and the flat node_modules
        - cp -r .next/standalone/apps/web/. ../../deploy/
        - cp -r .next/standalone/node_modules ../../deploy/
        
        # 3. Copy static and public assets (Next.js standalone doesn't include these)
        - mkdir -p ../../deploy/.next/static
        - cp -r .next/static/. ../../deploy/.next/static/
        - cp -r public/. ../../deploy/public/
        
        # 4. NUCLEAR STEP: Delete the source apps/web directory
        # This prevents the Amplify Bundler from ever seeing the 'pg' collision
        - cd ../..
        - rm -rf apps/web
  artifacts:
    # 5. Tell Amplify to only care about this clean, flat folder
    baseDirectory: deploy
    files:
      - '**/*'
  cache:
    paths:
      - apps/web/.next/cache/**/*